#!/bin/bash
#
# ========================================================================================
# Copyright (C) 2005-2010 UDW-SOFTWARE <http://udw.altervista.com/>
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
#
# This script will export all tables from specified db and tables in separated sql files
# it can also export the full db in a single sql file.
# =========================================================================================

echo "starting import process.."
# check config from same folder and include only if exists
CONF_FILE=$MT_DIR"/mysql_config"
if [ -f "$CONF_FILE" ]; then
    source "$CONF_FILE"
fi;

#overwrite configs if file exists and variables are defined
if [ ! -z "$4" ]; then
	source "$4"
fi;

source $MT_DIR"/shared_def"

# Table prefix ( to implement )
PFX=

# par 1 : db_name
function checkdb {
    # Check if database exists
    err=`echo "quit" | $(eval "$MYSQL$OPTS '$1'") 2>&1`
    if [ $? != 0 ]; then
        if echo "$err" | grep -q "Access denied"; then
            echo -e "\nDATABASE $1 EXISTS BUT USER $MYSQL_USER DOES NOT HAVE ACCESS TO IT, ABORTING"
            exit
        fi
        echo -n "[creating $1]"
        if ! echo "CREATE DATABASE $1;" | $(eval "$MYSQL$OPTS" )  2>/dev/null  ; then
            echo -e "\nDATABASE $1 DOES NOT EXIST AND I FAILED TO CREATE IT, ABORTING"
            exit
        fi
    fi
}

#par1: is_text_file ;  par2: file
function import
{
    echo "Importing $2 into $MYSQL_DB (text: $1) ..."
	if (($1 != 0)); then
		$(eval "$MYSQLIMPORT$OPTS $IMPORTOPTS_TEXT '$MYSQL_DB' '$2'")
	else
		$(eval "$MYSQL$OPTS '$MYSQL_DB'" < "$2" ) 
	fi
        echo " done"
}

if [ ! -z "$1" ]; then 
	DB=$1; 
fi

checkdb $MYSQL_DB

if [ ! -z "$2" ]; then 
	tables=$(echo $2 | tr "," "\n")
fi
if [ ! -z "$3" ]; then 
	FULL=$3; 
fi

if (($FULL != 0)); then
	echo "importing full world file"
	$(eval "$MYSQL$OPTS '$MYSQL_DB'") < $FPATH
else
	if [ ! -z "$2" ]; then
		import "0" "$TPATH/$2.sql"
		if (($TEXTDUMPS != 0)); then
			import "1" "$TPATH/*.txt"
		fi
	else
		for x in $TPATH/*.sql; do
			import "0" "$x"
		done
		
		if (($TEXTDUMPS != 0)); then
			import "1" "$TPATH/*.txt"
		fi
	fi
fi
